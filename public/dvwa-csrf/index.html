<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Gwendal Le Coguic">
    <meta name="description" content="Gwendal Le Coguic, web developer and bug hunter">
    <meta name="keywords" content="development,security,researcher,bugbounty,tools,php,python">

    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://10degres.net/assets/img/header-background.jpg"/>

<meta name="twitter:title" content="DVWA - CSRF"/>
<meta name="twitter:description" content="Cross-Site Request Forgery aka CSRF is an attack unintentionally triggered by the user himself.
It sends HTTP requests to execute unexpected actions in different ways: trough img tag to perform GET requests or with Ajax requests when POST is required.
You can learn basic CSRF in DVWA.
To perform this CSRF you firstly need to log in, then you must visit a malicious site who will perform a stealth HTTP request who will submit the change password form with specific values.
Low
The original request can be found by using a local proxy like Burp Suite or analyzing HTTP headers with a browser extension like Live HTTP Headers.
The payload:
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My malicious website&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;It works like a charm!&lt;/p&gt;
    &lt;img src=&#34;http://local.dvwa.com/vulnerabilities/csrf/?password_new=azerty&amp;password_conf=azerty&amp;Change=Change&#34; width=&#34;1&#34; height=&#34;1&#34; /&gt;
  &lt;/body&gt;
&lt;/html&gt;
"/>
<meta name="twitter:site" content="@10degres"/>
<meta name="twitter:creator" content="@gwendallecoguic"/>

    <meta property="og:title" content="DVWA - CSRF" />
<meta property="og:description" content="Cross-Site Request Forgery aka CSRF is an attack unintentionally triggered by the user himself.
It sends HTTP requests to execute unexpected actions in different ways: trough img tag to perform GET requests or with Ajax requests when POST is required.
You can learn basic CSRF in DVWA.
To perform this CSRF you firstly need to log in, then you must visit a malicious site who will perform a stealth HTTP request who will submit the change password form with specific values.
Low
The original request can be found by using a local proxy like Burp Suite or analyzing HTTP headers with a browser extension like Live HTTP Headers.
The payload:
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My malicious website&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;It works like a charm!&lt;/p&gt;
    &lt;img src=&#34;http://local.dvwa.com/vulnerabilities/csrf/?password_new=azerty&amp;password_conf=azerty&amp;Change=Change&#34; width=&#34;1&#34; height=&#34;1&#34; /&gt;
  &lt;/body&gt;
&lt;/html&gt;
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://10degres.net/dvwa-csrf/" />

<meta property="og:image" content="http://10degres.net/assets/img/header-background.jpg" />
<meta property="article:published_time" content="2015-03-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-03-26T00:00:00+00:00" /><meta property="og:site_name" content="10degres" />


    
      <base href="http://10degres.net/dvwa-csrf/">
    
    <title>
  DVWA - CSRF · 10degres
</title>

    
      <link rel="canonical" href="http://10degres.net/dvwa-csrf/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="http://10degres.net/assets/css/coder.min.3d8325016df2bf0f0e874e28c83131f668a953cb3245cf9391fae4ff5b76b2ed.css" integrity="sha256-PYMlAW3yvw8Oh04oyDEx9mipU8syRc&#43;Tkfrk/1t2su0=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://10degres.net/assets/css/custom.css" />
    

    <link rel="icon" type="image/png" href="http://10degres.net/assets/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://10degres.net/assets/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.91.0" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://10degres.net/">
      10degres
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars">aaa</i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://10degres.net/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://10degres.net/cves/">CVEs</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://10degres.net/services/">Services</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://10degres.net/press/">Press</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://10degres.net/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">DVWA - CSRF</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2015-03-26T00:00:00Z'>
                March 26, 2015
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              2 minutes read
            </span>
          </div>
          
          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="http://10degres.net/tags/dvwa/">dvwa</a>
      <span class="separator">•</span>
    <a href="http://10degres.net/tags/csrf/">csrf</a></div>

        </div>
      </header>

      <div>
        <p>Cross-Site Request Forgery aka CSRF is an attack unintentionally triggered by the user himself.
It sends HTTP requests to execute unexpected actions in different ways: trough <code>img</code> tag to perform <code>GET</code> requests or with Ajax requests when <code>POST</code> is required.
You can learn basic CSRF in <a href="http://10degres.net/damn-vulnerable-web-application/" title="Damn Vulnerable Web Application">DVWA</a>.</p>
<p>To perform this CSRF you firstly need to log in, then you must visit a malicious site who will perform a stealth HTTP request who will submit the change password form with specific values.</p>
<h2 id="low">Low</h2>
<p>The original request can be found by using a local proxy like Burp Suite or analyzing HTTP headers with a browser extension like <a href="https://addons.mozilla.org/fr/firefox/addon/live-http-headers/">Live HTTP Headers</a>.
The payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">html</span>&gt;
  &lt;<span style="color:#f92672">head</span>&gt;
    &lt;<span style="color:#f92672">title</span>&gt;My malicious website&lt;/<span style="color:#f92672">title</span>&gt;
  &lt;/<span style="color:#f92672">head</span>&gt;
  &lt;<span style="color:#f92672">body</span>&gt;
    &lt;<span style="color:#f92672">p</span>&gt;It works like a charm!&lt;/<span style="color:#f92672">p</span>&gt;
    &lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://local.dvwa.com/vulnerabilities/csrf/?password_new=azerty&amp;password_conf=azerty&amp;Change=Change&#34;</span> <span style="color:#a6e22e">width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#a6e22e">height</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> /&gt;
  &lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;
</code></pre></div><p>The attributes <code>width</code> and <code>height</code> are only used to hide the broken image.
This code displays:</p>
<p><img src="http://10degres.net/images/dvwa-csrf-low.png" alt="dvwa csrf low"></p>
<p>The hash of the password changed in my database from <code>5f4dcc3b5aa765d61d8327deb882cf99</code> to <code>ab4f63f9ac65152575886860dde480a1</code>, so it worked perfectly&hellip;
We can now take a look at the Apache logs.</p>
<p>Access log of the malicious server:</p>
<p><img src="http://10degres.net/images/dvwa-csrf-malicious.png" alt="dvwa csrf malicious"></p>
<p>Access log of the DVWA server:</p>
<p><img src="http://10degres.net/images/dvwa-csrf-access.png" alt="dvwa csrf access"></p>
<p>However an error has been generated because we tried to display an image which is not:</p>
<p><img src="http://10degres.net/images/dvwa-csrf-error.png" alt="dvwa csrf error"></p>
<h2 id="medium">Medium</h2>
<p>In this level a protection has been implemented.
The developper checks the referer to be sure that the incoming request comes from the same local server.
However this control is defective.
If I rename my script on my malicious server from <code>payload.html</code> to <code>127.0.0.1.html</code> it will work.
Plus the regexp is mal formed and doesn&rsquo;t protect special chars like dot &lsquo;<code>.</code>&rsquo; so <code>127908071.html</code> or <code>aa127U0B0K1zz.php</code> are also valid filenames.</p>
<h2 id="high">High</h2>
<p>Finally this level is well protected.
The old password is required (which should be only known by the concerned user himself) and cannot be predicted in an automated script.</p>
<p>There is differents ways to secure sensitive actions. A well known method is to use a random token placed in the form and checked after the submission.
Another approach is to configure the sessions to close with the browser and with a limited timelife. That way the time window when the vulnerability is effective is shorter.</p>
<h2 id="external-resources">External resources</h2>
<ul>
<li><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">OWASP description</a></li>
<li><a href="http://portswigger.net/burp/">Burp Suite by PortSwigger</a></li>
</ul>
      </div>

      <footer>
        


      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>
</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-61485350-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
      <script src="http://10degres.net/assets/js/scripts.js"></script>
    
    
  </body>

</html>
